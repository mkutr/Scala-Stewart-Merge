package steward.merge.services

import steward.merge.entities.BranchInfo
import zio.logging.{Logging, log}
import io.circe.parser.decode

import io.circe.generic.JsonCodec
import io.circe._, io.circe.parser._
import zio.{Has, ZIO, ZLayer}
object JsonParser {
  type JsonParserEnv = Has[JsonParser.Service]

  trait Service {
    def parseJson(input: String): ZIO[Logging, Throwable, List[BranchInfo]]
  }

  val live: ZLayer[Any, Nothing, Has[Service]] = ZLayer.succeed(new Service {
    override def parseJson(input: String): ZIO[Logging, io.circe.Error, List[BranchInfo]] = {
//      val analyze = input.trim
//val rawJson2: String = """
// {"body":"Updates [com.timushev.sbt:sbt-updates](https://github.com/rtimush/sbt-updates) from 0.6.1 to 0.6.2.\n[GitHub Release Notes](https://github.com/rtimush/sbt-updates/releases/tag/0.6.2) - [Version Diff](https://github.com/rtimush/sbt-updates/compare/0.6.1...0.6.2)\n\nI'll automatically update this PR to resolve conflicts as long as you don't change it yourself.\n\nIf you'd like to skip this version, you can just close this PR. If you have any feedback, just mention me in the comments below.\n\nConfigure Scala Steward for your repository with a [`.scala-steward.conf`](https://github.com/scala-steward-org/scala-steward/blob/17235ca1e60ff61e35fe7b7cf51163a15ffc435d/docs/repo-specific-configuration.md) file.\n\nHave a fantastic day writing Scala!\n\n<details>\n<summary>Files still referring to the old version number</summary>\n\nThe following files still refer to the old version number (0.6.1).\nYou might want to review and update them manually.\n```\nbuild.sbt\n```\n</details>\n<details>\n<summary>Ignore future updates</summary>\n\nAdd this to your `.scala-steward.conf` file to ignore future updates of this dependency:\n```\nupdates.ignore = [ { groupId = \"com.timushev.sbt\", artifactId = \"sbt-updates\" } ]\n```\n</details>\n\nlabels: sbt-plugin-update, early-semver-minor, semver-spec-patch, old-version-remains, commit-count:1","headRefName":"update/sbt-updates-0.6.2","number":1280,"statusCheckRollup":[{"__typename":"CheckRun","name":"compile and test NFS","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-18T15:33:08Z","completedAt":"2022-02-18T15:58:20Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5249803432?check_suite_focus=true"},{"__typename":"CheckRun","name":"Shellcheck","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-18T15:33:08Z","completedAt":"2022-02-18T15:33:11Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5249803326?check_suite_focus=true"}],"title":"Update sbt-zupdates to 0.6.2"}
//
//"""

      val rawJson: String = """
 [{"body":"Updates [com.timushev.sbt:sbt-updates](https://github.com/rtimush/sbt-updates) from 0.6.1 to 0.6.2.\n[GitHub Release Notes](https://github.com/rtimush/sbt-updates/releases/tag/0.6.2) - [Version Diff](https://github.com/rtimush/sbt-updates/compare/0.6.1...0.6.2)\n\nI'll automatically update this PR to resolve conflicts as long as you don't change it yourself.\n\nIf you'd like to skip this version, you can just close this PR. If you have any feedback, just mention me in the comments below.\n\nConfigure Scala Steward for your repository with a [`.scala-steward.conf`](https://github.com/scala-steward-org/scala-steward/blob/17235ca1e60ff61e35fe7b7cf51163a15ffc435d/docs/repo-specific-configuration.md) file.\n\nHave a fantastic day writing Scala!\n\n<details>\n<summary>Files still referring to the old version number</summary>\n\nThe following files still refer to the old version number (0.6.1).\nYou might want to review and update them manually.\n```\nbuild.sbt\n```\n</details>\n<details>\n<summary>Ignore future updates</summary>\n\nAdd this to your `.scala-steward.conf` file to ignore future updates of this dependency:\n```\nupdates.ignore = [ { groupId = \"com.timushev.sbt\", artifactId = \"sbt-updates\" } ]\n```\n</details>\n\nlabels: sbt-plugin-update, early-semver-minor, semver-spec-patch, old-version-remains, commit-count:1","headRefName":"update/sbt-updates-0.6.2","number":1280,"statusCheckRollup":[{"__typename":"CheckRun","name":"compile and test NFS","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-18T15:33:08Z","completedAt":"2022-02-18T15:58:20Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5249803432?check_suite_focus=true"},{"__typename":"CheckRun","name":"Shellcheck","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-18T15:33:08Z","completedAt":"2022-02-18T15:33:11Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5249803326?check_suite_focus=true"}],"title":"Update sbt-updates to 0.6.2"},{"body":"Updates [com.google.api-client:google-api-client](https://github.com/googleapis/google-api-java-client) from 1.33.1 to 1.33.2.\n[GitHub Release Notes](https://github.com/googleapis/google-api-java-client/releases/tag/v1.33.2) - [Version Diff](https://github.com/googleapis/google-api-java-client/compare/v1.33.1...v1.33.2)\n\nI'll automatically update this PR to resolve conflicts as long as you don't change it yourself.\n\nIf you'd like to skip this version, you can just close this PR. If you have any feedback, just mention me in the comments below.\n\nConfigure Scala Steward for your repository with a [`.scala-steward.conf`](https://github.com/scala-steward-org/scala-steward/blob/17235ca1e60ff61e35fe7b7cf51163a15ffc435d/docs/repo-specific-configuration.md) file.\n\nHave a fantastic day writing Scala!\n\n<details>\n<summary>Ignore future updates</summary>\n\nAdd this to your `.scala-steward.conf` file to ignore future updates of this dependency:\n```\nupdates.ignore = [ { groupId = \"com.google.api-client\", artifactId = \"google-api-client\" } ]\n```\n</details>\n\nlabels: library-update, early-semver-patch, semver-spec-patch, commit-count:1","headRefName":"update/google-api-client-1.33.2","number":1278,"statusCheckRollup":[{"__typename":"CheckRun","name":"compile and test NFS","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-16T10:29:11Z","completedAt":"2022-02-16T10:48:01Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5214616243?check_suite_focus=true"},{"__typename":"CheckRun","name":"Shellcheck","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-16T10:29:10Z","completedAt":"2022-02-16T10:29:14Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5214616381?check_suite_focus=true"}],"title":"Update google-api-client to 1.33.2"},{"body":"Updates [com.google.oauth-client:google-oauth-client-jetty](https://github.com/googleapis/google-oauth-java-client) from 1.33.0 to 1.33.1.\n[GitHub Release Notes](https://github.com/googleapis/google-oauth-java-client/releases/tag/v1.33.1) - [Version Diff](https://github.com/googleapis/google-oauth-java-client/compare/v1.33.0...v1.33.1)\n\nI'll automatically update this PR to resolve conflicts as long as you don't change it yourself.\n\nIf you'd like to skip this version, you can just close this PR. If you have any feedback, just mention me in the comments below.\n\nConfigure Scala Steward for your repository with a [`.scala-steward.conf`](https://github.com/scala-steward-org/scala-steward/blob/17235ca1e60ff61e35fe7b7cf51163a15ffc435d/docs/repo-specific-configuration.md) file.\n\nHave a fantastic day writing Scala!\n\n<details>\n<summary>Ignore future updates</summary>\n\nAdd this to your `.scala-steward.conf` file to ignore future updates of this dependency:\n```\nupdates.ignore = [ { groupId = \"com.google.oauth-client\", artifactId = \"google-oauth-client-jetty\" } ]\n```\n</details>\n\nlabels: library-update, early-semver-patch, semver-spec-patch, commit-count:1","headRefName":"update/google-oauth-client-jetty-1.33.1","number":1279,"statusCheckRollup":[{"__typename":"CheckRun","name":"compile and test NFS","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-18T14:19:02Z","completedAt":"2022-02-18T14:37:51Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5248818829?check_suite_focus=true"},{"__typename":"CheckRun","name":"compile and test NFS","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-18T14:19:46Z","completedAt":"2022-02-18T14:42:21Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5248828024?check_suite_focus=true"},{"__typename":"CheckRun","name":"compile and test NFS","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-18T15:35:02Z","completedAt":"2022-02-18T15:58:01Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5249828682?check_suite_focus=true"},{"__typename":"CheckRun","name":"Shellcheck","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-18T14:19:03Z","completedAt":"2022-02-18T14:19:06Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5248819003?check_suite_focus=true"},{"__typename":"CheckRun","name":"Shellcheck","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-18T14:19:47Z","completedAt":"2022-02-18T14:19:51Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5248828145?check_suite_focus=true"},{"__typename":"CheckRun","name":"Shellcheck","status":"COMPLETED","conclusion":"SUCCESS","startedAt":"2022-02-18T15:35:02Z","completedAt":"2022-02-18T15:35:05Z","detailsUrl":"https://github.com/VirtuslabRnD/nfs-core/runs/5249828798?check_suite_focus=true"}],"title":"Update google-oauth-client-jetty to 1.33.1"}]

"""
//      val rawJson: String = "0"
//      val s = decode[BranchInfo](rawJson2)

        for {
//        _ <- log.debug(input)
//        d = decode[List[Int]](rawJson)
//        _ <- log.debug(d.toString())
//        x <- ZIO.fromEither(decode[List[BranchInfo]](rawJson2))
        x <- ZIO.fromEither(decode[List[BranchInfo]](rawJson))
//        x <- ZIO.fromEither(s)
        _ <- log.debug(x.toString())
      } yield x
    }
  })

  def parseJson(input: String): ZIO[JsonParserEnv with Logging, Throwable, List[BranchInfo]] = {
    ZIO.accessM(hasService => hasService.get.parseJson(input))
  }
}
